pipeline {
    agent {
      docker {
              image 'node:lts-buster-slim'
              args '-p 3000:3000'
          }
        }
    stages {
        stage('Installation') {
            steps {
                sh 'npm i'
            }
        }
        stage('Run test'){
          steps{
            sh 'npm run test'
          }
        }
        stage('Build image')
        {
          steps{
            sh 'docker build --build-arg CLIENT_ID=79ccc48a450cd4e391a8 -t takenote:mytag .'
          }
        }
        stage('Push to DockerHub')
        {
          steps{
            withCredentials([usernamePassword(credentialsId: 'dockerHubAccount', usernameVariable: 'USERNAME',\
             passwordVariable: 'PASSWORD')]) {
               sh "docker login -u ${USERNAME} -p ${PASSWORD}"
               sh "docker tag takenote:mytag mmaaasshhaaaaa/takenote:latest"
               sh "docker push mmaaasshhaaaaa/takenote:latest"
               echo "Image push complete"
             }
          }
        }
    }
}
